<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Land Transfer</title>
  <style>
   * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #232526, #414345);
  color: #fff;
  min-height: 100vh;
  padding: 40px 20px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  overflow-y: auto;
}

.form-box {
  background: rgba(0, 0, 0, 0.8);
  padding: 30px;
  border-radius: 12px;
  width: 100%;
  max-width: 450px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
}

h2 {
  text-align: center;
  margin-bottom: 20px;
  color: #00e676;
}

label {
  margin-top: 15px;
  display: block;
  font-weight: 500;
}

input {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border: none;
  border-radius: 6px;
  background-color: #2c2c2c;
  color: #fff;
}

button {
  margin-top: 15px;
  padding: 12px;
  width: 100%;
  background: #00c853;
  border: none;
  color: white;
  font-size: 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background: #00e676;
}

.output {
  margin-top: 20px;
  text-align: center;
  font-weight: bold;
}

.output.success {
  color: #00e676;
}

.output.error {
  color: #ff5252;
}

  </style>
</head>
<body>
  <div class="form-box">
    <h2>Transfer Land Ownership</h2>
    <form id="transferForm">
      <label>Old Owner ID:</label>
      <input type="number" id="oldOwnerId" required />

      <label>New Owner ID:</label>
      <input type="number" id="newOwnerId" required />

      <label>Land ID:</label>
      <input type="number" id="landId" required />

      <label>New Owner Name:</label>
      <input type="text" id="ownerName" required />

      <label>New Owner Gender:</label>
      <input type="text" id="gender" required />

      <label>New Owner Mobile No:</label>
      <input type="text" id="mobile" required />

      <label>New Owner Email:</label>
      <input type="email" id="newEmail" required />

      <!-- Add below inputs to your form -->

      <label>Enter OTP sent to Old Owner Email:</label>
      <input type="text" id="oldOtp" required />
      
      <label>Enter OTP sent to New Owner Email:</label>
      <input type="text" id="newOtp" required />
      
      <!-- Button to send OTPs -->
      <button type="button" id="sendOtpBtn">Send OTPs to Both Emails</button>
      

      <div class="output" id="priceTaxOutput"></div>

      <button type="submit">Transfer</button>
    </form>
    <div class="output" id="resultMessage"></div>
  </div>

  <script>
    const landIdInput = document.getElementById('landId');
    const priceTaxOutput = document.getElementById('priceTaxOutput');
    const form = document.getElementById('transferForm');
    const resultMessage = document.getElementById('resultMessage');
    
    landIdInput.addEventListener('blur', async () => {
      const l_id = landIdInput.value;
      if (!l_id) return;
      const res = await fetch(`/get-price/${l_id}`);
      const data = await res.json();
      if (data.price) {
        priceTaxOutput.innerHTML = `üí∞ Price: ‚Çπ${data.price}<br>üßæ Tax (15%): ‚Çπ${data.tax}`;
      } else {
        priceTaxOutput.innerHTML = `‚ùå ${data.error}`;
      }
    });



const sendOtpBtn = document.getElementById('sendOtpBtn');

sendOtpBtn.addEventListener('click', async () => {
  const oldOwnerId = document.getElementById('oldOwnerId').value;
  const newEmail = document.getElementById('newEmail').value;

  if (!oldOwnerId || !newEmail) {
    alert("Please fill in both Owner ID and New Email first.");
    return;
  }

  // 1. Fetch Old Owner's Email
  const fetchOld = await fetch(`/get-owner-email/${oldOwnerId}`);
  const fetchOldJson = await fetchOld.json();

  if (!fetchOld.ok) {
    alert("Failed to fetch old owner's email.");
    return;
  }

  const oldEmail = fetchOldJson.email; // ‚úÖ Get email from response

  // 2. Send OTPs
  const sendToOld = await fetch('/send-otp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: oldEmail })
  });

  const sendToNew = await fetch('/send-otp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: newEmail })
  });

  const oldRes = await sendToOld.json();
  const newRes = await sendToNew.json();

  if (!sendToOld.ok || !sendToNew.ok) {
    alert("Failed to send OTP to one or both emails.");
  } else {
    alert("‚úÖ OTPs sent to both emails successfully!");
  }
});
document.getElementById("oldOwnerId").addEventListener("blur", function () {
  const ownerId = this.value.trim();
  const landIdInput = document.getElementById("landId");
  const msg = document.getElementById("resultMessage");

  if (!ownerId) return;

  fetch(`/check-land-land/${ownerId}`)
    .then(res => res.json())
    .then(data => {
      if (data.l_id) {
        landIdInput.value = data.l_id;
        msg.textContent = ""; // clear any error message
        msg.className = "output"; // reset class if needed
      } else {
        landIdInput.value = "";
        msg.textContent = data.message || "No land found.";
        msg.className = "output error"; // red text if styled
      }
    })
    .catch(error => {
      console.error("Error:", error);
      landIdInput.value = "";
      msg.textContent = "Server error while checking land.";
      msg.className = "output error";
    });
});

    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const oldOwnerId = document.getElementById('oldOwnerId').value;
      const newOwnerId = document.getElementById('newOwnerId').value;
      const landId = document.getElementById('landId').value;
      const ownerName = document.getElementById('ownerName').value;
      const gender = document.getElementById('gender').value;
      const mobile = document.getElementById('mobile').value;
      const newEmail = document.getElementById('newEmail').value;
      
      // Send all data including new owner's email
      const res = await fetch('/transfer-land', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ oldOwnerId, newOwnerId, landId, ownerName, gender, mobile, newEmail })
      });
      
      const result = await res.json();
      resultMessage.className = 'output';
      if (res.ok) {
        resultMessage.classList.add('success');
        resultMessage.innerHTML = `‚úÖ Transfer Successful! Tax: ‚Çπ${result.tax}`;
        form.reset();
        priceTaxOutput.innerHTML = '';
      } else {
        resultMessage.classList.add('error');
        resultMessage.innerHTML = `‚ùå ${result.error}`;
      }
    });
  </script>
</body>
</html>
